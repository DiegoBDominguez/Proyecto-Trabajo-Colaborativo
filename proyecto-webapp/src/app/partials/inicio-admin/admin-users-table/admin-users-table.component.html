<div class="admin-users-wrapper">
  <div class="card">
    <div class="header-row">
      <div class="title-and-tools">
        <h3>Gestión de Usuarios</h3>
        <div class="tools">
          <input type="text" placeholder="Buscar por nombre o email" (input)="applySearch($any($event.target).value)" class="search-input" />
          <button class="btn-export" (click)="exportCsv()" title="Exportar CSV">Exportar</button>
        </div>
      </div>

      <div class="filters">
        <label>Rol:</label>
        <select [(ngModel)]="rolesFilter" (change)="applyRoleFilter()">
          <option value="all">Todos</option>
          <option value="admin">Admin</option>
          <option value="agente">Agente</option>
          <option value="usuario">Usuario</option>
        </select>
      </div>
    </div>

    <div *ngIf="loading" class="loading">Cargando usuarios…</div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8 pretty-table">

    <ng-container matColumnDef="avatar">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let row">
        <div class="avatar">{{ (row.first_name || '').charAt(0) + (row.last_name ? row.last_name.charAt(0) : '') }}</div>
      </td>
    </ng-container>

    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
      <td mat-cell *matCellDef="let row">{{row.id}}</td>
    </ng-container>

    <ng-container matColumnDef="nombre">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
      <td mat-cell *matCellDef="let row">{{row.first_name}} {{row.last_name}}</td>
    </ng-container>

    <ng-container matColumnDef="email">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
      <td mat-cell *matCellDef="let row">
        <div class="email-cell">{{row.email}}</div>
      </td>
    </ng-container>

    <ng-container matColumnDef="rol">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Rol</th>
      <td mat-cell *matCellDef="let row"><span class="role-badge {{row.rol}}">{{row.rol}}</span></td>
    </ng-container>

    <ng-container matColumnDef="tickets_total">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Total Tickets</th>
      <td mat-cell *matCellDef="let row" class="numeric">{{row.tickets_total || 0}}</td>
    </ng-container>

    <ng-container matColumnDef="tickets_open">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Abiertos</th>
      <td mat-cell *matCellDef="let row" class="numeric">{{row.tickets_open || 0}}</td>
    </ng-container>

    <ng-container matColumnDef="tickets_closed">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Cerrados</th>
      <td mat-cell *matCellDef="let row" class="numeric">{{row.tickets_closed || 0}}</td>
    </ng-container>

    <ng-container matColumnDef="fecha_registro">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Registro</th>
      <td mat-cell *matCellDef="let row">{{row.date_joined | date:'short'}}</td>
    </ng-container>

    <ng-container matColumnDef="ultimo_login">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>Últ. login</th>
      <td mat-cell *matCellDef="let row">{{row.last_login ? (row.last_login | date:'short') : '—'}}</td>
    </ng-container>

    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let row">
        <button class="btn-primary very-small" (click)="verUsuario(row)">Ver</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <mat-paginator class="paginator" [pageSizeOptions]="[5,10,25]" showFirstLastButtons></mat-paginator>
  </div>
</div>
